name: Build and Release APK

on:
  push:
    tags:
      - "v*" # Runs when a tag like "v1.0.0" is pushed
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.3.0)'
        required: true
        type: string
      changelog:
        description: 'Changelog for this release (use \n for new lines)'
        required: true
        type: string
      create_tag:
        description: 'Create git tag for this version?'
        required: true
        type: boolean
        default: true
  
permissions:
  contents: write

jobs:
  build:
    name: Build and Sign APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > keystore.jks

      - name: Set Environment Variables
        run: |
          echo "KEYSTORE_PATH=$PWD/keystore.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=$(echo -n '${{ secrets.KEYSTORE_PASSWORD }}')" >> $GITHUB_ENV
          echo "KEY_ALIAS=$(echo -n '${{ secrets.KEY_ALIAS }}')" >> $GITHUB_ENV
          echo "KEY_PASSWORD=$(echo -n '${{ secrets.KEY_PASSWORD }}')" >> $GITHUB_ENV

      - name: Grant Execute Permission to Gradle
        run: chmod +x gradlew

      - name: Build APK
        run: ./gradlew assembleRelease --stacktrace

      - name: Find Release APK
        id: find_apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name '*.apk' -print -quit)
          if [[ -z "$APK_PATH" ]]; then
            echo "No APK found!"
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK at: $APK_PATH"

      - name: Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Signed-APK
          path: ${{ steps.find_apk.outputs.apk_path }}

  release:
    name: Create GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Version Tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Download Signed APK
        uses: actions/download-artifact@v4
        with:
          name: Signed-APK
          path: artifacts/

      - name: Find Downloaded APK
        id: find_downloaded_apk
        run: |
          APK_PATH=$(find artifacts -name '*.apk' -print -quit)
          if [[ -z "$APK_PATH" ]]; then
            echo "No downloaded APK found!"
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Downloaded APK at: $APK_PATH"

      - name: Rename APK
        run: |
          mv "${{ steps.find_downloaded_apk.outputs.apk_path }}" "AttendX-${{ steps.version.outputs.tag }}-release.apk"

      - name: Install xmllint
        run: sudo apt-get install -y libxml2-utils

      - name: Extract Changelog
        run: |
          VERSION_TAG="${{ steps.version.outputs.tag }}"
          
          # Check if manual changelog was provided
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.changelog }}" ]; then
            CHANGELOG="${{ github.event.inputs.changelog }}"
          else
            # Extract from strings.xml
            VERSION_TAG_XML=$(echo $VERSION_TAG | tr '.' '_' | tr -d 'v')
            CHANGELOG=$(xmllint --xpath "string(//string[@name='changelogs_v${VERSION_TAG_XML}']/text())" app/src/main/res/values/strings.xml || echo "")
          fi

          if [[ -z "$CHANGELOG" ]]; then
            echo "No changelog found for $VERSION_TAG"
            CHANGELOG="Release $VERSION_TAG"
          fi

          # Replace \n with actual newlines and bullet points
          CHANGELOG=$(echo "$CHANGELOG" | sed 's/\\n/\n* /g')

          # Add header
          echo -e "### Changelog\n* $CHANGELOG" > changelog.txt
          
          echo "Generated changelog:"
          cat changelog.txt

      - name: Publish Release using gh CLI
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            "AttendX-${{ steps.version.outputs.tag }}-release.apk" \
            --title "AttendX ${{ steps.version.outputs.tag }}" \
            --notes-file changelog.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
