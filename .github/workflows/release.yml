name: Build and Release APK

on:
  push:
    tags:
      - "v*" # Runs when a tag like "v1.0.0" is pushed
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.3.0)'
        required: true
        type: string
      changelog:
        description: 'Changelog for this release (use \n for new lines)'
        required: true
        type: string
      create_tag:
        description: 'Create git tag for this version?'
        required: true
        type: boolean
        default: true
  
permissions:
  contents: write

jobs:
  build:
    name: Build and Sign APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > keystore.jks

      - name: Set Environment Variables
        run: |
          echo "KEYSTORE_PATH=$PWD/keystore.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=$(echo -n '${{ secrets.KEYSTORE_PASSWORD }}')" >> $GITHUB_ENV
          echo "KEY_ALIAS=$(echo -n '${{ secrets.KEY_ALIAS }}')" >> $GITHUB_ENV
          echo "KEY_PASSWORD=$(echo -n '${{ secrets.KEY_PASSWORD }}')" >> $GITHUB_ENV

      - name: Grant Execute Permission to Gradle
        run: chmod +x gradlew

      - name: Build APK
        run: ./gradlew assembleRelease --stacktrace

      - name: Find All Release APKs
        id: find_apks
        run: |
          APK_DIR="app/build/outputs/apk/release"
          APK_FILES=$(find "$APK_DIR" -name '*.apk' | tr '\n' ' ')
          if [[ -z "$APK_FILES" ]]; then
            echo "No APKs found!"
            exit 1
          fi
          echo "apk_dir=$APK_DIR" >> $GITHUB_OUTPUT
          echo "Found APKs: $APK_FILES"

      - name: Upload APKs as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Signed-APKs
          path: app/build/outputs/apk/release/*.apk

  release:
    name: Create GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Version Tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Download Signed APKs
        uses: actions/download-artifact@v4
        with:
          name: Signed-APKs
          path: artifacts/

      - name: List and Rename APKs
        id: rename_apks
        run: |
          VERSION="${{ steps.version.outputs.tag }}"
          mkdir -p release-apks
          
          echo "Found APKs:"
          ls -la artifacts/
          
          # Rename each APK with version and architecture
          for apk in artifacts/*.apk; do
            filename=$(basename "$apk")
            # Extract architecture from filename (e.g., app-arm64-v8a-release.apk)
            if [[ "$filename" == *"arm64-v8a"* ]]; then
              newname="AttendX-${VERSION}-arm64-v8a.apk"
            elif [[ "$filename" == *"armeabi-v7a"* ]]; then
              newname="AttendX-${VERSION}-armeabi-v7a.apk"
            elif [[ "$filename" == *"x86_64"* ]]; then
              newname="AttendX-${VERSION}-x86_64.apk"
            elif [[ "$filename" == *"universal"* ]]; then
              newname="AttendX-${VERSION}-universal.apk"
            else
              newname="AttendX-${VERSION}-release.apk"
            fi
            cp "$apk" "release-apks/$newname"
            echo "Renamed: $filename -> $newname"
          done
          
          echo "Release APKs:"
          ls -la release-apks/

      - name: Install xmllint
        run: sudo apt-get install -y libxml2-utils

      - name: Extract Changelog
        run: |
          VERSION_TAG="${{ steps.version.outputs.tag }}"
          
          # Check if manual changelog was provided
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.changelog }}" ]; then
            CHANGELOG="${{ github.event.inputs.changelog }}"
          else
            # Extract from strings.xml
            VERSION_TAG_XML=$(echo $VERSION_TAG | tr '.' '_' | tr -d 'v')
            CHANGELOG=$(xmllint --xpath "string(//string[@name='changelogs_v${VERSION_TAG_XML}']/text())" app/src/main/res/values/strings.xml || echo "")
          fi

          if [[ -z "$CHANGELOG" ]]; then
            echo "No changelog found for $VERSION_TAG"
            CHANGELOG="Release $VERSION_TAG"
          fi

          # Replace \n with actual newlines and bullet points
          CHANGELOG=$(echo "$CHANGELOG" | sed 's/\\n/\n* /g')

          # Add header
          echo -e "### Changelog\n* $CHANGELOG" > changelog.txt
          
          echo "Generated changelog:"
          cat changelog.txt

      - name: Publish Release using gh CLI
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            release-apks/*.apk \
            --title "AttendX ${{ steps.version.outputs.tag }}" \
            --notes-file changelog.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
